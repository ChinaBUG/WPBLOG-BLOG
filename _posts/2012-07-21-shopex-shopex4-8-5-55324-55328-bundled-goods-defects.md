---
ID: 2129
post_title: >
  ShopEX-Shopex4.8.5.55324-55328的捆绑商品缺陷：捆绑商品库存不足
author: ChinaBUG
post_excerpt: |
  最近新建了4个捆绑商品，库存数量都蛮大的，可是其中两个捆绑商品前台下订单时一直提示“捆绑商品库存不足”，但是另外两个商品却没有这个问题。
  一看就不正常，不可能是一般程序的问题，所以从底层代码看起来，找呀找呀~
  终于找到原因了！
  下面是偶的研究心得哈~~自己看，看不懂我也不知道了。
  1.新建捆绑商品时，只在goods表内添加商品信息，并在package_product表中做链接。
  2.在products表中没有商品信息。
layout: post
permalink: >
  http://blog.ipodmp.com/2012/07/shopex-shopex4-8-5-55324-55328-bundled-goods-defects.html
published: true
post_date: 2012-07-21 14:35:21
---
最近新建了4个捆绑商品，库存数量都蛮大的，可是其中两个捆绑商品前台下订单时一直提示“捆绑商品库存不足”，但是另外两个商品却没有这个问题。

一看就不正常，不可能是一般程序的问题，所以从底层代码看起来，找呀找呀~

终于找到原因了！

下面是偶的研究心得哈~~自己看，看不懂我也不知道了。

1.新建捆绑商品时，只在goods表内添加商品信息，并在package_product表中做链接。

2.在products表中没有商品信息。

问题：

1.

因为在products表中没有商品信息，所以在方法调用时，就会出现商品不足！

因为products表中的商品信息不是捆绑商品的信息。

在mdl.order.php内的create方法调用mdl.cart.php内的_checkstore方法，_checkstore方法是读取products表内的信息。

2.

因为products表内没有信息，所以在下订单时会将goods_id当做是product_id来处理，造成查看订单详情时会出现错误。

举例子说明一下吧，这个其实我在看完整个业务流程时也是有点不能理解的哈~

比如：

我添加一个捆绑商品，在goods的编号为2012吧，也就是说goods_id这个字段的值是2012，根据上面的心得所述，我们在sdb_goods表中可以找到一个记录，goodsi_id为2012的，上面的信息肯定是我们录入的捆绑商品的信息。但是我们去sdb_products 去查看时却会发现，这边没有同时新意见一条记录！

正常情况下，我们添加商品时会在sdb_goods跟sdb_products 表中新建相关的商品信息，但是，捆绑商品却没有。

正常情况下，根据程序业务流程来说，这个时候在sdb_products 表中找不到记录是正确！这个捆绑商品时可以添加成功的，也不会出现“捆绑商品库存不足”的提示的。

但是，现在我们假设，你再一次添加一个普通的商品，这个商品的goods_id等于10000吧，其实这个一点关系都没有，关键是下面的值。那么我们根据设计在sdb_products 表中肯定会出现与之联系的一个记录，我们假设这个记录的product_id等于2012好了！记住一定要是2012，其他的都随便了，但是这个记录的库存我们填写0吧，然后就去测试一下，你会发现，刚才可以添加的捆绑商品现在不可以了，会一直提示“捆绑商品库存不足”！

当然你把这个值弄大一点的话，捆绑商品又可以添加了哈。

从上面的例子，我们可以得出结论，捆绑商品存在缺陷！在机缘巧合情况下是会出现这种乌龙事件的。正如，我遇上的，连续两个捆绑商品都不行哦。

怎么解决这个情况？呵呵，目前我也不知道，懒得去修改这个问题了。这边提供一下临时解决办法了：

获取错误的列表：

SELECT * FROM cdb_products WHERE product_id in(SELECT goods_id FROM cdb_goods WHERE goods_type='bind') order by product_id

上面的语句将错误的记录挑出来，你只要把挑出来的记录的product_id值改一个就可以了。